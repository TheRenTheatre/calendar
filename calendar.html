<style>
  table#ren-events thead {
    display: none;
  }
  table#ren-events th, td {
    padding: 0.5rem 0;
    font-size: 1.2rem;
  }
  /* Date column */
  table#ren-events th[scope=row] {
    padding-right: 0.8rem;
    font-size: 1rem;
    text-align: right;
    font-weight: bold;
    vertical-align: top;
    white-space: nowrap;
    line-height: 2.1rem;
  }
  table#ren-events th[scope=row].multiple {
    font-weight: inherit;
  }
  /* Time column */
  table#ren-events td {
    padding-right: 1.5rem;
    text-align: right;
    font-size: 1rem;
    vertical-align: top;
    white-space: nowrap;
    line-height: 2.1rem;
  }
  /* Event column */
  table#ren-events td:last-of-type {
    padding-right: 0;
    text-align: left;
    font-size: 1.2rem;
    white-space: inherit;
    line-height: inherit;
  }
  table#ren-events td:last-of-type small {
    line-height: 1.4rem;
    margin-top: 0.4rem;
  }
  table#ren-events tr.past {
    opacity: 0.5;
  }
  table#ren-events tr.cancelled th[scope=row]:not([rowspan]),
  table#ren-events tr.cancelled td,
  table#ren-events tr td span.cancelled {
    opacity: 0.5;
  }
  table#ren-events tr.hidden-by-script,
  table#ren-events tr.future-hidden {
    display: none;
  }
  table#ren-events tr.break td {
    text-align: center;
    vertical-align: top;
    padding-top: 4px;
    padding-bottom: 4px;
  }
  table#ren-events tr.break td::after {
    content: "\0022EE";
    font-weight: lighter;
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.6);
  }
  table#ren-events tr.doublebreak td::before {
    content: "\0022EE";
    font-weight: lighter;
    font-size: 1rem;
    color: rgba(255, 255, 255, 0.6);
  }
  table#ren-events a:not([class]) {
    text-decoration-color: #888;
    text-decoration-thickness: 0.05rem;
  }
  table#ren-events td:last-of-type a:not([href^="https://tickets.rentheatre.com"]):first-of-type {
    padding-right: 0.2rem;
  }
  table#ren-events td:last-of-type a[href^="https://tickets.rentheatre.com"] {
    font-weight: bold;
  }
  table#ren-events a.otr,
  table#ren-events small.otr {
    color: #ffa1eb;
    text-decoration-color: #ffa1eb;
    font-family: monospace;
    word-spacing: -0.1rem;
  }
  table#ren-events a.otr span.thinsp,
  table#ren-events small.otr span.thinsp {
    word-spacing: -0.3rem;
  }
  table#ren-events a.otr {
    font-weight: bold;
    text-decoration-thickness: 0.05rem;
    font-size: 80%;
    display: inline-block;
    line-height: 1.5rem !important;
  }
  table#ren-events small.otr {
    font-size: 65%;
    display: inline-block;
    line-height: 1.4rem !important;
  }
  table#ren-events a.mm {
    color: #ffc700;
    font-weight: bold;
  }
  table#ren-events tr.cancelled a.mm {
    color: inherit;
    font-weight: inherit;
  }
  table#ren-events a.nosferatu {
    font-weight: bold;
    color: #bb3333;
  }
  table#ren-events a.vbar {
    font-weight: bold;
    font-style: italic;
    color: silver;
  }
  table#ren-events a.afters {
    font-style: italic;
    color: #ffc700;
    font-weight: bold;
  }
  table#ren-events a.fromhere {
    font-weight: bold;
    font-style: italic;
    color: #ffde00;
  }
  table#ren-events a.fringe {
    font-size: 1.1rem;
    color: #c243ad;
    text-decoration-color: #555;
    text-decoration-thickness: 0.05rem;
    text-underline-offset: 0.1rem;
  }
  table#ren-events a.fringe em {
    color: #fff;
  }
  table#ren-events small.fringe,
  table#ren-events span.fringe {
    color: #f4735c;
  }
  .fe-6312b2c642d54c4207a169f7 {
    grid-template-rows: repeat(10, minmax(calc(var(--container-width) * var(--row-height-scaling-factor)), auto));
  }
  @media (min-width: 768px) {
    .fe-6312b2c642d54c4207a169f7 {
      grid-template-rows: repeat(16, minmax(calc(var(--container-width) * var(--row-height-scaling-factor)), auto));
    }
  }
  .mobile-only  { display: inherit; }
  .desktop-only { display: none; }
  @media (min-width: 768px) {
    .mobile-only  { display: none; }
    .desktop-only { display: inherit; }
  }
</style>

<table id="ren-events">
  <thead>
    <tr>
      <th scope="col">Date</th>
      <th scope="col">Time</th>
      <th scope="col">Event</th>
    </tr>
  </thead>
  <tbody>

    <tr>
      <th scope="row">Mon, Aug 26</th>
      <td>8:00 PM</td>
      <td>
        <a href="#musical-mondays" class="mm">
          Musical Mondays
        </a>
        <br>
        <small>
          (doors 7:30)
        </small>
      </td>
    </tr>

    <tr>
      <th scope="row">Wed, Aug 28</th>
      <td>10:30 PM</td>
      <td>
        <a href="https://www.instagram.com/otrwednesdays/" class="otr">OTR&#160;/&#160;off the record</a>
        <br>
        <small class="otr">drag / bops</small>
        <br>
        <small>(doors 10:00)</small>
      </td>
    </tr>

    <tr>
      <th scope="row" class="multiple" colspan="2">
        Final shows in NYC!<br>through <strong>Aug 31<sup>st</sup></strong>
      </th>
      <td>
        <a href="https://aintdonebad.com" class="aintdonebad"><em><strong>Ainâ€™t Done Bad</strong></em></a>
        (<a href="https://aintdonebad.com">tickets</a>)<br>
        <small>The Ren presents Jakob Karrâ€™s groundbreaking show off-broadway</small>
      </td>
    </tr>

    <tr class="cancelled">
      <th scope="row">Mon, Sep 2</th>
      <td></td>
      <td>
        No Musical Mondays this week or next<br>
        <small><em>(the coven is preparing for Nosferatu!)</em></small>
      </td>
    </tr>

    <tr class="break">
      <td colspan="3"></td>
    </tr>

    <tr>
      <th scope="row" rowspan="3">Fri, Sep 13</th>
      <td>7:00 PM</td>
      <td>
        <a href="/nosferatu" class="nosferatu"><em>Nosferatu:</em> The Choosing</a>
        (<a href="https://tickets.rentheatre.com/nosferatu">tickets</a>)
      </td>
    </tr>
    <tr>
      <td>8:00 PM</td>
      <td>
        <a href="/nosferatu" class="nosferatu"><em>Nosferatu:</em> The Wandering</a>
        (<a href="https://tickets.rentheatre.com/nosferatu">tickets</a>)
        <br>
        <small><em>opening night!</em></small>
      </td>
    </tr>
    <tr>
      <td>11:30 PM</td>
      <td>
        <a href="/nosferatu" class="vbar">V-Bar</a>
        (<a href="https://tickets.rentheatre.com/nosferatu">tickets</a>)
        <br>
        <small>(doors 11:00)</small>
      </td>
    </tr>

    <tr>
      <th scope="row" rowspan="3">Sat, Sep 14</th>
      <td>7:00 PM</td>
      <td>
        <a href="/nosferatu" class="nosferatu"><em>Nosferatu:</em> The Choosing</a>
        (<a href="https://tickets.rentheatre.com/nosferatu">tickets</a>)
      </td>
    </tr>
    <tr>
      <td>8:00 PM</td>
      <td>
        <a href="/nosferatu" class="nosferatu"><em>Nosferatu:</em> The Wandering</a>
        (<a href="https://tickets.rentheatre.com/nosferatu">tickets</a>)
      </td>
    </tr>
    <tr>
      <td>11:30 PM</td>
      <td>
        <a href="/nosferatu" class="vbar">V-Bar</a>
        (<a href="https://tickets.rentheatre.com/nosferatu">tickets</a>)
        <br>
        <small>(doors 11:00)</small>
      </td>
    </tr>

    <tr class="break">
      <td colspan="3"></td>
    </tr>

    <tr>
      <th scope="row" colspan="2" class="multiple">
        Fri, Sep 20<sup>th</sup>&thinsp;â€“&thinsp;Sun, Nov 10<sup>th</sup>
      </th>
      <td>
        <a href="/nosferatu" class="nosferatu"><em>Nosferatu</em></a> and&nbsp;
        <a href="/nosferatu" class="vbar">V-Bar</a>
        (<a href="https://tickets.rentheatre.com/nosferatu">tickets</a>)
        <br>
        <small><em>vampires roam all season long at the Ren</em> ðŸ˜ˆðŸ©¸</small>
      </td>
    </tr>

    <!--
    <tr>
      <th scope="row" class="multiple">
        <strong>Wed, Feb 14<sup>th</sup></strong><br>
        and <strong>Wed, Feb 21<sup>st</sup></strong>
      </th>
      <td>10:30 PM</td>
      <td>
        <a href="https://tickets.rentheatre.com/thank-u-next" class="otr">thank u,<span class="thinsp"> </span>next</a>
        (<a href="https://tickets.rentheatre.com/thank-u-next">tickets</a>)
        <br>
        <small class="otr"><em>another drop from <span class="desktop-only thinsp">&nbsp;</span><b>off&#160;the&#160;record</b></em></small>
        <br>
        <small>(doors 9:30)</small>
      </td>
    </tr>
    -->

    <!-- multiple example 1
    <tr>
      <th scope="row" colspan="2" class="multiple">
        Thu, May 4<sup>th</sup>&thinsp;â€“&thinsp;Sat, May 6<sup>th</sup>
      </th>
      <td>
        <a href="/the-cocaine-play" class="the-cocaine-play">The Cocaine Play</a> â€”
        <a href="https://rentheatre.ticketspice.com/the-cocaine-play">tickets</a>
        <br>
        <small>Thursdayâ€“Saturday nights, final weekend</small>
      </td>
    </tr>
    -->

    <!-- multiple example 2
    <tr>
      <th scope="row" colspan="2" class="multiple">
        August weekends
      </th>
      <td>
        <a href="/fiftyfour" class="fiftyfour">54</a> and <a href="/fiftyfour" class="fiftyfour ah">54 After Hours</a> â€”
        <a href="https://rentheatre.ticketspice.com/54">tickets</a>
        <br>
        <small>Fridayâ€“Saturday nights, all summer long</small>
      </td>
    </tr>
    -->

    <!-- tbd break
    <tr class="break">
      <td colspan="3"></td>
    </tr>
    -->

  </tbody>
</table>

<script>
  // Utility function: return the year implied by the argument, a string
  // like "Dec 20", and the current date.
  function closestYearToDateString(dateStr) {
    currentYear = (new Date()).getFullYear();
    nearestUnixTimeFound = NaN;
    [currentYear - 1, currentYear, currentYear + 1].forEach((year) => {
      ms = Date.parse(dateStr + " " + year);
      if (isNaN(nearestUnixTimeFound) ||
          Math.abs(Date.now() - ms) < Math.abs(Date.now() - nearestUnixTimeFound)) {
        nearestUnixTimeFound = ms;
      }
    });
    return (new Date(nearestUnixTimeFound)).getFullYear();
  }

  // Iterate over each row; parse the date and time; assign the class "past"
  // once we get to 3 hours after start time. Hide a row once we're a day out.
  // NOTE: this is hardcoded for EST. Fix :)
  function moveCalendarRowsToPastBasedOnCurrentTime() {
    hoursElapsedToMarkAsPassed = 3
    hoursElapsedToMarkAsPassedForFringe = 0.5
    hoursElapsedToHide = 24
    hoursElapsedToHideForFringe = 18
    hoursElapsedToHideWhenMarkedKeepLonger = 36

    dateText = "";
    document.querySelectorAll("#ren-events tbody tr:not(.break)").forEach(tr => {
      timeText = "";

      if (dateCol = tr.querySelector("th[scope=row].multiple")) {
        // Use the first snippet that matches e.g. "Mar 22" as the date, no matter where it occurs
        // Examples: "Fridays and Saturdays,\nMar 22ndâ€‰â€“â€‰May 5th", "Thu, Feb 22ndâ€‰â€“â€‰Sun, Mar 10th"
        dateText = dateCol.innerText.match(/(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ([1-9][0-9]?)/)[0];
        dateText = dateText + " " + closestYearToDateString(dateText);
        if (dateCol.colSpan == 2) {
          timeText = "12:00 PM";
        }
      } else if (dateCol = tr.querySelector("th[scope=row]:not(.multiple)")) {
        dateText = dateCol.firstChild.data.trim();
        dateText = dateText + " " + closestYearToDateString(dateText);

        // While we're here... a side-track. Add an ordinal, only for the
        // simplest case of a single well-formed date without one.
        if (matches = dateCol.textContent.match(/^(Sun|Mon|Tue|Wed|Thu|Fri|Sat), (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ([1-9][0-9]?)$/)) {
          sup = document.createElement("sup");
          sup.innerHTML = ["st", "nd", "rd"][((+matches[3] + 90) % 100 - 10) % 10 - 1] || "th";
          dateCol.insertAdjacentElement("beforeend", sup);
        }
      }

      if (timeText == "") {
        if (timeCol = tr.querySelector("td:first-of-type")) {
          timeText = timeCol.innerText.replaceAll("\n", "").split("â€“")[0].trim();
          timeText = timeText.replace(/\b(?<!:)(?<hour>1[0-9]|[1-9]) (?<ampm>[AP]M)/i, "$<hour>:00 $<ampm>");
        }
      }

      startTimeMs = Date.parse(dateText + " " + timeText + " UTC-0400");

      isFringe = !!(tr.querySelector("a.fringe"));

      if (new URL(window.location).searchParams.get("renConsoleLog") == "1") {
        // Find the event name for logging
        link = tr.querySelector("td:last-of-type a");
        eventName = link ? link.innerText : tr.querySelector("td:last-of-type").innerText;
        eventName = eventName.replaceAll("\n", " ").trim();

        console.log({eventName: eventName, dateText: dateText, timeText: timeText,
                     startTimeMs: startTimeMs, isFringe: isFringe, tr: tr});
      }

      if (!isNaN(startTimeMs)) {
        hoursPassedSinceStart = (Date.now() - startTimeMs) / 1000 / 60 / 60;
        if ((hoursPassedSinceStart > hoursElapsedToMarkAsPassed) ||
            (isFringe && hoursPassedSinceStart > hoursElapsedToMarkAsPassedForFringe)) {
          tr.classList.add("past");
        } else {
          tr.classList.remove("past");
        }
        if ((hoursPassedSinceStart > hoursElapsedToHideWhenMarkedKeepLonger) ||
            (hoursPassedSinceStart > hoursElapsedToHide && !tr.classList.contains("keep-longer")) ||
            (isFringe && hoursPassedSinceStart > hoursElapsedToHideForFringe)) {
          tr.classList.add("hidden-by-script")
          th = tr.querySelector("th[scope=row]");
          rowspan = 1;
          if (th) {
            rowspan = +th.getAttribute("rowspan");
          }
          if (rowspan > 1) {
            nextTr = tr.nextElementSibling;
            nextTh = document.createElement("th");
            nextTh.setAttribute("scope", "row");
            if (rowspan > 2) {
              nextTh.setAttribute("rowspan", rowspan - 1);
            }
            nextTh.innerHTML = th.innerHTML;
            nextTr.insertAdjacentElement("afterbegin", nextTh);
            th.removeAttribute("rowspan");
          }
        }
      }
    });
  }


  // The top-level function
  function processCalendarTable() {
    moveCalendarRowsToPastBasedOnCurrentTime();
  }

  if (document.readyState === "loading") {
    // Loading hasn't finished yet
    document.addEventListener("DOMContentLoaded", processCalendarTable);
  } else {
    // `DOMContentLoaded` has already fired
    processCalendarTable();
  }
</script>
